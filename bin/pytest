#!/bin/bash -e
set -eo pipefail

# source "$(dirname "$0")/_config.sh"

# Recreate the redis sentinel service to avoid inconsistent state
docker-compose up -d -V redis-sentinel

# Database and elactic search
echo "ðŸ’½(db) DB_HOST=$DB_HOST"
docker-compose up -d "$DB_HOST" elasticsearch

docker-compose run --rm dockerize -wait "tcp://$DB_HOST:$DB_PORT" -timeout 60s
docker-compose run --rm dockerize -wait tcp://elasticsearch:9200 -timeout 60s
docker-compose run --rm \
    -e DJANGO_CONFIGURATION=Test \
    -e PYTHONPATH=/app \
    -e DB_HOST="$DB_HOST" \
    app-dev pytest "$@"
